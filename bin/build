#!/usr/bin/env sh
# These files are added by the post receive hook
# from git. Since we're not in a git repo

REGISTRY="quay.io/leaplines"

BRANCH=`cat BRANCH`
VERSION=`head -c8 VERSION`
CWD=`basename $PWD`
LAST=${BRANCH##*/}
IMAGE="$REGISTRY/$CWD:$LAST"
IMAGE2="$REGISTRY/$CWD:$VERSION"

echo "-----------------------------"
echo "Building $LAST on $VERSION"
echo "-----------------------------"

echo docker build -t $IMAGE -t $IMAGE2 .
echo docker push $IMAGE2

echo "-----------------------------"

docker build -t $IMAGE -t $IMAGE2 .
docker push $IMAGE2

echo "-----------------------------"
echo "Image build: $IMAGE $IMAGE2"
echo "kubectl set image -n platform deployment/web web=$IMAGE2"